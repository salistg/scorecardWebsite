<!DOCTYPE html>
<html>
<head>
    <title>Google Sheets Data Retrieval</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        .high-accuracy {
            background-color: green;
            display: inline-block;
            padding: 5px;
            border-radius: 3px;
        }
    
        .low-accuracy {
            background-color: red;
            display: inline-block;
            padding: 5px;
            border-radius: 3px;
        }

        .active {
        background-color: #ccc;
    }

    .filter-container {
            margin-top: 20px;
        }

    </style>
    
</head>
<body>
    <h1>Week Tab</h1>
    
    <div class="tabs">
        <button class="tab-button" id="classificationTab">Image Classification</button>
        <button class="tab-button" id="annotationTab">Image Annotation</button>
    </div>
    
    <div id="weekTabsContainer" style="display: none;"></div>
    <div id="projectTabsContainer" style="display: none;"></div>

    
    <div id="dataContainer"></div>
    
    <script>
        const classificationTabButton = document.getElementById("classificationTab");
        const annotationTabButton = document.getElementById("annotationTab");
        const weekTabsContainer = document.getElementById("weekTabsContainer");
        const projectTabsContainer = document.getElementById("projectTabsContainer");
        const dataContainer = document.getElementById("dataContainer");
        let classificationData = [];
        let annotationData = [];
        let currentFilteredData = [];
        let selectedTab = "Image Classification"; // Default selected tab
        let selectedWeek = null;

        classificationTabButton.addEventListener("click", () => {
            selectedTab = "Image Classification";
            clearDataAndWeekTabs();
            fetchClassificationData();
        });

        annotationTabButton.addEventListener("click", () => {
            selectedTab = "Image Annotation";
            clearDataAndWeekTabs();
            fetchAnnotationData();
        });

        function clearDataAndWeekTabs() {
            weekTabsContainer.innerHTML = "";
            projectTabsContainer.innerHTML = "";
            dataContainer.innerHTML = "";
            classificationData = [];
            annotationData = [];
            selectedWeek = null;
        }

        function fetchClassificationData() {
            gapi.load("client", initClient);

            function initClient() {
                gapi.client.init({
                    apiKey: "AIzaSyATmqw9OCHZrbU2fnwQ3eC2gkwYp5_GLc0", // Your Google Sheets API Key
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                }).then(function() {
                    // Fetch data from the Google Sheet for classification
                    gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: "1OhGhXRxBeEi4kTqqCwoIfrrfSHaBvMokqdovCeT4Wds", // ID of your Google Sheet
                        range: "Image Classification Scorecards!A2:K", // Fetch columns D to K
                    }).then(function(response) {
                        const data = response.result.values;
                        classificationData = data;
                        populateWeekTabs(data);
                    });
                });
            }
        }

        function fetchAnnotationData() {
            gapi.load("client", initClient);

            function initClient() {
                gapi.client.init({
                    apiKey: "AIzaSyATmqw9OCHZrbU2fnwQ3eC2gkwYp5_GLc0", // Your Google Sheets API Key
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                }).then(function() {
                    // Fetch data from the Google Sheet for annotation
                    gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: "1OhGhXRxBeEi4kTqqCwoIfrrfSHaBvMokqdovCeT4Wds", // ID of your Google Sheet
                        range: "Image Annotation Scorecards!A2:N", // Fetch columns D to N
                    }).then(function(response) {
                        const data = response.result.values;
                        annotationData = data;
                        populateWeekTabs(data);
                    });
                });
            }
        }

        function populateWeekTabs(data) {
    const filteredData = data.filter(row => row[1] === "July" && row[0] === "2023"); // Month at index 1, Year at index 0
    const weekColumn = filteredData.map(row => row[2]); // Assuming Week column is at index 2
    const uniqueWeeks = Array.from(new Set(weekColumn));

    weekTabsContainer.innerHTML = "";

    uniqueWeeks.forEach(week => {
        const tabButton = document.createElement("button");
        tabButton.className = "tab-button";
        tabButton.textContent = week;
        weekTabsContainer.appendChild(tabButton);

        tabButton.addEventListener("click", () => {
            selectedWeek = week;
            fetchAndPopulateData(selectedWeek); // Fetch and populate data when week tab is clicked
        });
    });

    weekTabsContainer.style.display = "block";
}

function fetchAndPopulateData(week) {
    dataContainer.innerHTML = ""; // Clear the data container

    const data = selectedTab === "Image Classification" ? classificationData : annotationData;
    const filteredData = filterDataByWeek(data, week);
    currentFilteredData = filteredData; // Store the filtered data
    populateProjectTabs(filteredData); // Use filteredData to populate project tabs
}

function populateProjectInfo(projectName, week, filteredData) {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: "1OhGhXRxBeEi4kTqqCwoIfrrfSHaBvMokqdovCeT4Wds", // ID of your Google Sheet
                range: `Overall project scores!A:G`, // Range to fetch data from 'Overall project scores' tab
            }).then(function(response) {
                // const projectInfo = response.result.values.find(row => row[2] === week && row[4] === projectName);
                // console.log("Fetched Project Info:", projectInfo); // Add this line
                console.log("Searching for week:", week);
                console.log("Searching for project:", projectName);
                const projectInfo = response.result.values.find(row => {
                    console.log("Current row:", row);
                    return row[2].toLowerCase() === week.toLowerCase() && row[4].toLowerCase() === projectName.toLowerCase();
                });
                console.log("Fetched Project Info:", projectInfo);

                if (projectInfo) {
                    const projectInfoContainer = document.createElement("div");
                    
                    // Create the Annotator ID input field and filter button
                    const annotatorIdInput = document.createElement("input");
                    annotatorIdInput.setAttribute("type", "text");
                    annotatorIdInput.setAttribute("placeholder", "Enter Annotator ID");
                    annotatorIdInput.id = "annotatorIdInput";

                    const filterButton = document.createElement("button");
                    filterButton.textContent = "Filter";
                    filterButton.addEventListener("click", () => {
                        const annotatorId = document.getElementById("annotatorIdInput").value.trim();
                        populateProjectInfo(projectName, week, filteredData)
                        // currentFilteredData = filterDataByAnnotatorId(filteredData, annotatorId);
                        if (annotatorId === "") {
                            displayData(filteredData); // Display full data if annotator ID is empty
                        } else {
                            currentFilteredData = filterDataByAnnotatorId(filteredData, annotatorId);
                            displayData(currentFilteredData);
                        }
                    });

                    const projectInfoName = document.createElement("p");
                    projectInfoName.textContent = `Project Name: ${projectInfo[4]}`;

                    const projectInfoID = document.createElement("p");
                    projectInfoID.textContent = `Project ID: ${projectInfo[5]}`;

                    const projectInfoType = document.createElement("p");
                    projectInfoType.textContent = `Project Type: ${projectInfo[3]}`;

                    const projectInfoAccuracy = document.createElement("p");
                    projectInfoAccuracy.textContent = `Overall Project Accuracy: ${projectInfo[6]}`;

                    // Determine the accuracy value and set the CSS class
                    const accuracyValue = parseFloat(projectInfo[6]);
                        if (accuracyValue >= 90) {
                            projectInfoAccuracy.classList.add("high-accuracy");
                        } else {
                            projectInfoAccuracy.classList.add("low-accuracy");
                        }

                    projectInfoContainer.appendChild(projectInfoName);
                    projectInfoContainer.appendChild(projectInfoID);
                    projectInfoContainer.appendChild(projectInfoType);
                    projectInfoContainer.appendChild(projectInfoAccuracy);

                    dataContainer.appendChild(annotatorIdInput);
                    dataContainer.appendChild(filterButton);

                    dataContainer.insertBefore(filterButton, dataContainer.firstChild);
                    dataContainer.insertBefore(annotatorIdInput, dataContainer.firstChild);
                    
                    dataContainer.appendChild(projectInfoContainer);

                    dataContainer.insertBefore(projectInfoContainer, dataContainer.firstChild);

                }
            });
        }


        function filterDataByAnnotatorId(data, annotatorId) {
            const columnIndex = selectedTab === "Image Classification" ? 6 : 6;
            return data.filter(row => row[columnIndex] === annotatorId);
        }


        function populateProjectTabs(data) {
            const projectColumn = data.map(row => row[4]); // Assuming Project Name column is at index 4
            const uniqueProjects = Array.from(new Set(projectColumn));

            projectTabsContainer.innerHTML = "";

            uniqueProjects.forEach(project => {
                const tabButton = document.createElement("button");
                tabButton.className = "tab-button";
                tabButton.textContent = project;
                projectTabsContainer.appendChild(tabButton);

                tabButton.addEventListener("click", () => {
                    const filteredData = filterDataByProject(data, project);
                    currentFilteredData = filteredData; // Store the filtered data
                    dataContainer.innerHTML = ""; // Clear the data container
                    // populateProjectTabs(filteredData);
                    populateProjectInfo(project, selectedWeek, filteredData); // Fetch and display project info
                    displayData(filteredData);

                    document.querySelectorAll('.project-tab-button').forEach(btn => {
                        if (btn.textContent === project) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                });
            });

            projectTabsContainer.style.display = "block";
        }

        function filterDataByWeek(data, week) {
            return data.filter(row => row[2] === week);
        }

        function filterDataByProject(data, project) {
            return data.filter(row => row[4] === project);
        }

        function displayData(data) {
            dataContainer.innerHTML = "<h2>Fetched Data:</h2>";
            
            if (data.length > 0) {
                const table = document.createElement("table");
                const headerRow = document.createElement("tr");

                // Create header cells
                Object.keys(data[0]).forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header;
                    headerRow.appendChild(th);
                });

                table.appendChild(headerRow);

                // Create data rows
                data.forEach(row => {
                    const dataRow = document.createElement("tr");
                    Object.values(row).forEach(value => {
                        const td = document.createElement("td");
                        td.textContent = value;
                        dataRow.appendChild(td);
                    });
                    table.appendChild(dataRow);
                });

                dataContainer.appendChild(table);
            } else {
                const message = document.createElement("p");
                message.textContent = "No data available.";
                dataContainer.appendChild(message);
            }
        }
    </script>
</body>
</html>